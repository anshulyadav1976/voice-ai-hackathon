<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoDiary - Call Details</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <div>
                <h1>üéôÔ∏è EchoDiary</h1>
                <p class="subtitle">Call Details</p>
            </div>
        </div>
        <nav class="container">
            <a href="/">Call History</a>
            <a href="/graph.html">Knowledge Graph</a>
            <a href="/stats.html">Statistics</a>
        </nav>
    </header>

    <div class="container">
        <div class="card">
            <button onclick="history.back()" class="btn btn-secondary" style="margin-bottom: 16px;">‚Üê Back</button>
            
            <div id="call-details">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading call details...</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Transcript</h2>
            <div class="transcript" id="transcript">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading transcript...</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Actions</h2>
            <div style="display: grid; gap: 12px;">
                <button class="btn btn-primary" onclick="generateReflection()" id="reflection-btn">üéµ Generate Reflection</button>
                <button class="btn btn-secondary" onclick="reconversate()">üìû Call Me About This</button>
                
                <div style="margin-top: 8px; border-top: 1px solid #E5E7EB; padding-top: 12px;">
                    <p style="font-weight: 600; margin-bottom: 12px; color: #374151;">üì• Download & Export</p>
                    <div style="display: grid; gap: 8px;">
                        <button class="btn btn-secondary" onclick="downloadAudio()" id="audio-download-btn">
                            üéµ Download Audio Recording
                        </button>
                        <button class="btn btn-secondary" onclick="exportTranscript('text')">
                            üìÑ Export as Text
                        </button>
                        <button class="btn btn-secondary" onclick="exportTranscript('markdown')">
                            üìù Export as Markdown
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="reflection-result" style="margin-top: 16px; display: none;">
                <div style="background: #F3F4F6; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                    <strong>Reflection:</strong>
                    <p id="reflection-text" style="margin-top: 8px; line-height: 1.6;"></p>
                </div>
                <button class="btn btn-secondary" onclick="speakReflection()">üîä Read Aloud</button>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const callId = urlParams.get('id');

        async function loadCallDetails() {
            try {
                const response = await fetch(`/api/calls/${callId}`);
                const call = await response.json();
                
                const date = new Date(call.start_time);
                const moodClass = call.mood_score 
                    ? (call.mood_score >= 7 ? 'mood-positive' : call.mood_score >= 4 ? 'mood-neutral' : 'mood-negative')
                    : 'mood-neutral';
                
                document.getElementById('call-details').innerHTML = `
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <strong>Date:</strong> ${date.toLocaleString()}
                        </div>
                        <div>
                            <strong>Duration:</strong> ${call.duration_seconds ? Math.floor(call.duration_seconds / 60) + ' minutes' : 'Active'}
                        </div>
                        <div>
                            <strong>Mode:</strong> <span class="tag">${call.mode}</span>
                        </div>
                        ${call.mood_score ? `
                            <div>
                                <strong>Mood Score:</strong> 
                                <span class="mood-badge ${moodClass}">
                                    ${call.mood_score.toFixed(1)} / 10
                                </span>
                            </div>
                        ` : ''}
                        ${call.sentiment ? `
                            <div>
                                <strong>Sentiment:</strong> ${call.sentiment}
                            </div>
                        ` : ''}
                        ${call.tags && call.tags.length > 0 ? `
                            <div>
                                <strong>Topics:</strong>
                                <div class="tags">
                                    ${call.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${call.summary ? `
                            <div>
                                <strong>Summary:</strong>
                                <p style="margin-top: 8px; line-height: 1.6;">${call.summary}</p>
                            </div>
                        ` : ''}
                        ${call.audio_url ? `
                            <div>
                                <strong>Audio Recording:</strong>
                                <div class="audio-player">
                                    <audio controls src="${call.audio_url}"></audio>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Load transcript
                if (call.transcripts && call.transcripts.length > 0) {
                    document.getElementById('transcript').innerHTML = call.transcripts.map(turn => {
                        const turnDate = new Date(turn.timestamp);
                        return `
                            <div class="transcript-turn ${turn.speaker}">
                                <div class="speaker-label">
                                    ${turn.speaker === 'user' ? 'You' : 'EchoDiary'}
                                    <span style="font-weight: normal; margin-left: 8px;">${turnDate.toLocaleTimeString()}</span>
                                </div>
                                <div class="transcript-text">${turn.text}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('transcript').innerHTML = '<p style="text-align: center; color: #6B7280;">No transcript available</p>';
                }
                
            } catch (error) {
                console.error('Error loading call:', error);
                document.getElementById('call-details').innerHTML = '<p style="color: #EF4444;">Error loading call details</p>';
            }
        }

        async function generateReflection() {
            const btn = document.getElementById('reflection-btn');
            const resultDiv = document.getElementById('reflection-result');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';
            
            try {
                const response = await fetch(`/api/reflection/${callId}`, { method: 'POST' });
                
                if (!response.ok) {
                    throw new Error('Failed to generate reflection');
                }
                
                const data = await response.json();
                
                // Display reflection
                document.getElementById('reflection-text').textContent = data.reflection;
                resultDiv.style.display = 'block';
                
                btn.textContent = '‚úÖ Reflection Generated';
                
                // Auto-play after 1 second
                setTimeout(() => speakReflection(), 1000);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate reflection. Please try again.');
                btn.disabled = false;
                btn.textContent = 'üéµ Generate Reflection';
            }
        }
        
        function speakReflection() {
            const text = document.getElementById('reflection-text').textContent;
            
            if ('speechSynthesis' in window) {
                // Use Web Speech API
                window.speechSynthesis.cancel(); // Stop any ongoing speech
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Try to find a good voice
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => v.name.includes('Female') || v.name.includes('Samantha')) || voices[0];
                if (preferredVoice) utterance.voice = preferredVoice;
                
                window.speechSynthesis.speak(utterance);
            } else {
                alert('Speech synthesis not supported in your browser. Please read the reflection text above.');
            }
        }

        function reconversate() {
            alert('Feature coming soon! This will initiate an outbound call to discuss this conversation further.');
        }

        async function downloadAudio() {
            const btn = document.getElementById('audio-download-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Downloading...';
            
            try {
                // Try to download audio file with download flag
                const response = await fetch(`/api/calls/${callId}/audio?download=true`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Audio recording not available yet. It will be available after the call ends.');
                    }
                    throw new Error(`Failed to download audio: ${response.statusText}`);
                }
                
                // Check if it's a direct file or a URL
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('audio')) {
                    // Direct file download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    
                    // Get filename from Content-Disposition header if available
                    const disposition = response.headers.get('content-disposition');
                    let filename = `echodiary_call_${callId}.wav`;
                    if (disposition && disposition.includes('filename=')) {
                        const matches = disposition.match(/filename="?([^"]+)"?/);
                        if (matches && matches[1]) {
                            filename = matches[1];
                        }
                    }
                    
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }, 100);
                    
                    btn.textContent = '‚úÖ Downloaded!';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 2000);
                } else {
                    // URL response (fallback)
                    const data = await response.json();
                    if (data.audio_url) {
                        // Open in new tab for external URLs
                        window.open(data.audio_url, '_blank');
                        btn.textContent = '‚úÖ Opened in new tab!';
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.textContent = originalText;
                        }, 2000);
                    } else {
                        throw new Error('No audio URL available');
                    }
                }
                
            } catch (error) {
                console.error('Error downloading audio:', error);
                alert(`‚ö†Ô∏è ${error.message || 'Audio recording not available for this call.'}`);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function exportTranscript(format) {
            try {
                // Trigger download
                const url = `/api/calls/${callId}/export/${format}`;
                const link = document.createElement('a');
                link.href = url;
                link.download = true;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('Error exporting transcript:', error);
                alert('‚ö†Ô∏è Failed to export transcript. Please try again.');
            }
        }

        loadCallDetails();
    </script>
</body>
</html>

